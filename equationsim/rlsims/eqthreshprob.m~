%=============================================================
%SIM OF PROBABALISTIC 2 STATE TASK WITHOUT REACH THRESHOLDS =
%fluid prob shift after x trials test subject has to adapt
cont = 1; %each prob separately tested as n(101) trials
%if cont = 2; prob tested successively, one after the other (101*reps) trials
%softmax is based on prob generated by softmax, 
%init = 1; init = 0 choose higher prob side ;init = 1; random 0.5 prob between choice

%=============================================================
choices = 2;
choice = 1;
probstate =1; %1 = incresing prob e.g., 0.1,0.2,0.3... 2= follows prl1
%=====================================================================
prl0 = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1];
prl1 = [0.1, 0.1, 0.25, 0.25, 0.5, 0.5, 0.75, 0.75, 0.9, 0.9];
prl = [prl0;prl1];
aci = 0.1;
agi = 0.1;
ani = 0.1;
bgi = 1;
bni = 1;
% func, v, g, n, act, prob1
vi = 0.5;
gi = 1;
ni = 1;
acti = 0;
rewvalue = 1;
inczero = 1;
trials = 100;
reps = 10;%at different probs
simtot = 1000;%total repetitition
shiftstate = 1;
tt = trials + inczero;
st = tt*reps;
ch = cell(simtot);%1000,2 choices
sm = zeros(st,choices,simtot);
%====================================================================================
%===prob generation==================================================================
%====================================================================================
prob = rand((st)* choices, simtot);% if 2 choices, first 1010rows for choice1 next 1010 for choice 2 etc.
pr = zeros(st,choices);%probability of reward
%first 1000 columns for choice1 next columns.
for i = 1: st
    pr(i,1) = prl(1,(fix((i-1)/(tt))+1));
    pr(i,2) = 1-pr(i,1);
end
%====================================================================================
%===simulation=======================================================================
%====================================================================================

for i = 1: simtot%1000 total sim
    for r = 1:reps% 10 different probabilities (10 if probstate = 0)
        for j = 1:tt%101 including 0 trials
            t = ((r-1)*tt + j);
            tiebreaker = randi(choices);
            for c = 1: choices%choices
                %t = ((r-1)*tt + j);
                if (j == 1 && cont == 1) || t == 1%first trial in every rep or first in general
                    sigmat = 0;
                    ch{i}(t,1,c) = vi;
                    ch{i}(t,2,c) = gi;
                    ch{i}(t,3,c) = ni;
                    ch{i}(t,4,c) = bgi*ch{i}(t,2,c)-bni*ch{i}(t,3,c);
                else
                    sigmat = (ch{i}(j-1,7,c) - ch{i}(t-1,1,c));%sigmat = r(t-1)-v(t-1)
                    ch{i}(t,1,c) = ch{i}(t-1,1,c) + aci*sigmat;%v(t) = v(t-1) + ac*sigmat
                    ch{i}(t,2,c) = ch{i}(t-1,2,c) + agi*sigmat*ch{i}(t-1,2,c);%g(t) = g(t-1) + ag*g(t-1)*sigmat
                    ch{i}(t,3,c) = ch{i}(t-1,3,c) + (-1)*agi*sigmat*ch{i}(t-1,3,c); %n(t) = n(t-1) + an*n(t-1)*sigmat
                    ch{i}(t,4,c) = bgi*ch{i}(t,2,c)-bni*ch{i}(t,3,c);%act(t) = bg*g(t) - bn*n(t)
                end
            end
%             sumc1 = ch{i,1}(t,4)+ch{i,2}(t,4);
%             sumc = sum(cellfun(@(x) x(t,4),ch(i)));
            for c = 1: choices
                if (j == 1 && cont == 1) || t == 1 || ch{i,1}(t,4) == ch{i,2}(t,4)%(range(ch{i,:}(t,4)) == 0)
                    ch{i}(t,5,c)= 1/choices;
                else 
                    ch{i}(t,5,c) = (exp(ch{i}(t,4,1)))/exp(ch{i}(t,4)+ ch{i,2}(t,4));
                end
                sm(t,c,i) = ch{i,c}(t,5);
            end
%====================================================================================
% DEFINE A SOFTMAX RULE
%====================================================================================
%           hardmax[M,I] = max(ch{i,1:choices}(t,5)); picks highest prob
            p = cumsum([0; sm(1,1:end-1).'; 1+1e3*eps]);
            [a, a] = histc(rand,p);
            for c = 1: choices
                if c == a
                    ch{i,c}(t,6) = 1;
                    if prob(j+((c-1)*simtot),i) <= pr(j,c)
                        ch{i,c}(t,7) = rewvalue;
                    else
                        ch{i,c}(t,7) = 0;
                    end
                else
                    ch{i,c}(t,6) = 0;
                    ch{i,c}(t,7) = 0;
                end
            end
        end
    end
end
%====================================================================================
GRAPHING
%====================================================================================
% avg = sum(cat()
for c = 1: choices

end
