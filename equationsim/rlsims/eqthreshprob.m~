%=============================================================
%SIM OF PROBABALISTIC 2 STATE TASK WITHOUT REACH THRESHOLDS =
%fluid prob shift after x trials test subject has to adapt
cont = 1; %each prob separately tested as n(101) trials
%if cont = 2; prob tested successively, one after the other (101*reps) trials
%softmax is based on prob generated by softmax, 
%init = 1; init = 0 choose higher prob side ;init = 1; random 0.5 prob between choice

%=============================================================
choices = 2;
cho = [1,2]
choice = 1;
probstate =1; %1 = incresing prob e.g., 0.1,0.2,0.3... 2= follows prl1
%=====================================================================
aci = 0.1;
agi = 0.1;
ani = 0.1;
bgi = 1;
bni = 1;
% func, v, g, n, act, prob1
vi = 0.5;
gi = 1;
ni = 1;
acti = 0;
rewvalue = 1;
inczero = 0;
trials = 50;
subji = 1;
prs = ad([diff(ad(:,5,1))]~=0,5,1);%prob subject
cls = (ad(:,(6+version),subji)==1);
crs = (ad(:,(6+version),subji)==2);
xs1 = [(ad(:,4,subji)==2),(ad(:,4,i)==1),cls,crs];
cc = reshape((ad(:,(6+version),i)==1),1,size(ad,1));
reps = length(prs);
%at different probs
simtot = 1000;%total repetitition
tt = trials + inczero;
st = tt*reps;
% ch = cell(simtot);%1000,2 choices
ch = zeros(st,7,choices,simtot);
sm = zeros(st,choices,simtot);
color = varycolor(reps);
%====================================================================================
%===simulation=======================================================================
%====================================================================================

for i = 1: simtot%1000 total sim
    for r = 1:reps% 10 different probabilities (10 if probstate = 0)
        for j = 1:tt%101 including 0 trials
            t = ((r-1)*tt + j);
            for c = 1: choices%choices
                %t = ((r-1)*tt + j);
               if t ==1 %first trial in every rep or first in general
                    sigmat = 0;
                    ch(t,1,c,i) = vi;
                    ch(t,2,c,i) = gi;
                    ch(t,3,c,i) = ni;
                    ch(t,4,c,i) = bgi*ch(t,2,c,i)-bni*ch(t,3,c,i);
                else
                    sigmat = (ch(t-1,7,c,i) - ch(t-1,1,c,i));%sigmat = r(t-1)-v(t-1)
                    ch(t,1,c,i) = ch(t-1,1,c,i) + aci*sigmat;%v(t) = v(t-1) + ac*sigmat
                    ch(t,2,c,i) = ch(t-1,2,c,i) + agi*sigmat*ch(t-1,2,c,i);%g(t) = g(t-1) + ag*g(t-1)*sigmat
                    ch(t,3,c,i) = ch(t-1,3,c,i) + (-1)*ani*sigmat*ch(t-1,3,c,i); %n(t) = n(t-1) + an*n(t-1)*sigmat
                    ch(t,4,c,i) = bgi*ch(t,2,c,i)-bni*ch(t,3,c,i);%act(t) = bg*g(t) - bn*n(t)
                end
            end
%====================================================================================
% DEFINE A SOFTMAX RULE
%====================================================================================
            sm = softmax([ch(t,4,1,i),ch(t,4,2,i)]');%correct softmax
            ch(t,5,1,i) = sm(1);
            ch(t,5,2,i) = sm(2);
            pick = cho(find(rand<cumsum(sm),1,'first'));

            if pick == (cls(t)+1)
                
                
            end
            for c = 1: choices
                if c == pick
                    ch(t,6,c,i) = 1;
                    if c == (cls(t)+1)
                        ch(t,7,c,i) = rewvalue;
                    else
                        ch(t,7,c,i) = 0;
                    end
                else
                    ch(t,6,c,i) = 0;
                    ch(t,7,c,i) = 0;
                end
            end
        end
    end
end
%====================================================================================
% GRAPHING
%====================================================================================
avg = sum(ch,4)/simtot;
choicemean = avg(:,6,1);
% avgc = 
% for c = 1: choice
% fv = reshape(avg(:,1,c),tt,reps);
% fg = reshape(avg(:,2,c),tt,reps);
% fn = reshape(avg(:,3,c),tt,reps);
% fact = reshape(avg(:,4,c),tt,reps);
% avgc = reshape(avg(:,5,c),tt,reps);
% figure(1);
%     subplot(4,2,c);
%     plot(0:length(fv)-1,fv);
%     title(['V(choice ' num2str(c) 'r=' num2str(rewvalue) ', p, increasing)']);
%     subplot(4,2,2+c);
%     plot(0:length(fg)-1,fg);
%     title(['G(choice' num2str(c) 'r=' num2str(rewvalue) ', p, increasing)']);
% 
%     subplot(4,2,4+c);
%     plot(0:length(fn)-1,fn);
%     title(['N(choice' num2str(c) 'r=' num2str(rewvalue) ', p, increasing)']);
% 
%     subplot(4,2,6+c);
%     plot(0:length(fact)-1,fact);
%     title(['Act(choice' num2str(c) 'r=' num2str(rewvalue) ', p, increasing)']);
%     xlabel('time');

% end
figure(2)
    (shade(xs1,0,hv, ht, col,lt));

        avgval = 20;
        plot(moveavg(cc,avgval), 'c');%
        plot(moveavg(pta(i,:),avgval),'k');
        l = legend('reach1',' ','reach2',' ','Reward target: left', ' ', 'Reward target: right' ,'', ...
            'P(reward|left) moving avg','Choice moving avg');
        l.FontSize = 16;
        xlabel('Trials');
        ylabel('Probability');
        xlim([0, size(ad,1)]);
        ylim([-0.2,1.3]);
        ha = axes('Position',[0 0 1 1],'Xlim',[0 1],'Ylim',[0 1],'Box','off','Visible','off','Units','normalized', 'clipping' , 'off');
        t = text(0.5, 1,['P(choose L) over time, usr ' num2str(i) ',movavg= ' num2str(avgval) ' trials'],'HorizontalAlignment' ...
        ,'center','VerticalAlignment', 'top');
        t.FontSize = 22;
      